<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Program">   

   	
   	<select id="readProgram" resultType="ProgramRead">
	   select P.id, A.name as name, C.category_name as category_name, P.program_name, P.status, P.apply_status, P.start_date, P.end_date , P.Applystart_date, P.Applyend_date , P.manager_name, P.manager_contact, P.applicants_num,P.apply_status,
	   		case
            when (P.apply_status = 0) then '대기'
            when (P.apply_status =1) then '진행'
        	else '마감'
			end as status_name
			
		FROM swap.Program as P
		LEFT JOIN swap.Category as C  
		ON P.category_id = C.id
		LEFT JOIN swap.Admin as A
		ON P.admin_id = A.id
		where P.deldate is null
		order by P.regdate desc;
   	</select>
   	
   	
   	  <select id="readByCategory" parameterType="Integer" resultType="ProgramRead">
   	  select P.id, A.name as name, P.program_name, C.category_name, P.category_id, P.quota, P.information, P.status,  P.apply_status, P.start_date, P.end_date, P.Applystart_date, P.Applyend_date , P.manager_name, P.manager_contact, P.applicants_num,
   	  		case
            when (P.apply_status = 0) then '대기'
            when (P.apply_status=1) then '진행'
        	else '마감'
			end as status_name
		FROM Program AS P
		LEFT JOIN Category as C
		ON P.category_id = C.id
		LEFT JOIN swap.Admin as A
		ON P.admin_id = A.id
		where  P.deldate is null AND C.id =  #{category_id}
		order by P.regdate desc;
	
   	</select>
   	
   	 <select id="readByStatusByUser" parameterType="hashmap" resultType="ProgramReadByUser">
   	  select  A.id as applicant_id, P.id as program_id, P.program_name,P.start_date, P.end_date,case
            when (A.status = 0) then '참여보류'
            when (A.status=1) then '참여승인'
            when (A.status=2) then '참여불가'
            when (A.status=3) then '미수료'
        else '수료'
	end as status_name
	FROM Applicant AS A
	LEFT JOIN Program P on P.id = A.program_id
	where P.deldate is null AND P.status = #{status} AND A.user_id=#{user_id}
	order by A.regdate desc;
	
   	</select>
   	
   		<select id="selectConfirmOngoing" parameterType="Integer" resultType="Integer">
	   select case when(P.status = 1) then 1
		else 0
		end
		from Program as P
		where P.id =#{id};
   	</select>
   	
   	 <select id="selectConfirmApply" parameterType="Integer" resultType="Integer">
   	select case when (P.applicants_num > 0) then 1
	else 0
	end
	from Program as P
	where P.id = #{id};
		</select>
   	
   	
   	<select id="readProgramInformationByProgramId" parameterType="Integer" resultType="ProgramReadById">
	   select P.id, P.program_name,P.category_id, C.category_name as category_name, P.quota, P.information, P.start_date, P.end_date, P.Applystart_date, P.Applyend_date, P.manager_name, P.manager_contact, P.applicants_num
		FROM Program AS P
		LEFT JOIN Category as C  
		ON P.category_id = C.id
		where P.id = #{id};
   	</select>
   	
   	<select id="readProgramFileByProgramId" parameterType="Integer" resultType="ProgramReadById">

   	</select>
   	
   	<select id="readProgramName" parameterType="Integer" resultType="ProgramReadName">
	   select P.program_name
		FROM Program AS P
		where P.id = #{id};
   	</select>
   	
   	<select id="readProgramLastId" resultType="Integer">
	    SELECT P.id
		FROM Program AS P
		ORDER BY regdate DESC LIMIT 1
   	</select>
   	
   	<insert id = "insertProgram" parameterType="Program">	
   		INSERT INTO Program (admin_id, category_id, application_form, program_name, information, start_date, end_date, quota, Applystart_date, Applyend_date, manager_name, manager_contact)
		VALUES (#{admin_id}, #{category_id}, #{application_form}, #{program_name}, #{information}, #{start_date}, #{end_date},#{quota}, #{Applystart_date}, #{Applyend_date},#{manager_name}, #{manager_contact})
   	</insert>
   	
   	<insert id = "insertPoster" parameterType="Program">	
   		INSERT INTO Program_File (program_id, file_name, file_type)
		VALUES (#{program_id}, #{file_name}, #{file_type})
   	</insert>
   	
   	<insert id = "insertFile" parameterType="Program">	
   		INSERT INTO Program_File (program_id, file_name, file_type)
		VALUES (#{program_id}, #{file_name}, #{file_type})
   	</insert>
   	
   	<update id="updateDelDate" parameterType="Integer">
   		UPDATE Program SET deldate=now(), status = -1
		WHERE id = #{id}
   	</update>
   	

   	<update id="updateStatus" parameterType="hashmap">
   		UPDATE Program SET status=#{status}
		WHERE id = #{program_id}
	</update>
	
	<update id="updateApplyStatus" parameterType="hashmap">
   		UPDATE Program SET apply_status=#{apply_status}
		WHERE id = #{program_id}
	</update>

   	<update id="edit" parameterType="Program">
   		UPDATE Program SET edit_date=now(), program_name = #{program_name}, information = #{information}, quota = #{quota}, category_id=#{category_id}, start_date=#{start_date}, end_date=#{end_date}, Applystart_date=#{Applystart_date}, Applyend_date=#{Applyend_date}, manager_name = #{manager_name}, manager_contact = #{manager_contact} 
		WHERE id = #{id}

   	</update>
   	
   	<update id="updateApplicantNum" parameterType="hashmap">
   		UPDATE Program SET applicants_num= applicants_num + 1
   		WHERE id = #{program_id}
	</update>
	
	  	<select id="readLikedPrograms" parameterType="Integer" resultType="ProgramReadById">
	   select P.id, P.program_name,P.category_id, C.category_name as category_name, P.quota, P.information, P.start_date, P.end_date, P.Applystart_date, P.Applyend_date, P.manager_name, P.manager_contact, P.applicants_num
		FROM Program AS P
		LEFT JOIN Category as C  
		ON P.category_id = C.id
		LEFT JOIN Bookmark as B  
		ON P.id = B.program_id
		where B.user_id = #{user_id};
   	</select>
   	
   	
</mapper>

